<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horarios de Actividades</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      min-height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .activity-card {
      transition: all 0.3s ease;
    }

    .activity-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .countdown {
      font-weight: 600;
      color: #667eea;
    }

    .form-container {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="min-h-full p-6">
   <div class="max-w-7xl mx-auto">

    <!-- Bot√≥n de regreso -->
    <div class="mb-6 fade-in">
      <a href="principal.html" class="inline-flex items-center px-6 py-3 bg-white bg-opacity-20 backdrop-blur-sm text-white font-semibold rounded-lg hover:bg-opacity-30 transition-all duration-300 shadow-lg">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg> 
        Regresar al Inicio
      </a>
    </div>

    <!-- Encabezado -->
    <header class="text-center mb-8 fade-in">
      <h1 id="page-title" class="text-5xl font-bold text-white mb-2">Horarios de Actividades</h1>
      <p class="text-white text-lg opacity-90">Gestiona tus actividades programadas</p>
    </header>

    <!-- Contenedor de actividades -->
    <div id="activities-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8"></div>

    <!-- Formulario -->
    <div class="form-container rounded-2xl shadow-2xl p-6 max-w-2xl mx-auto fade-in">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Agregar Nueva Actividad</h2>
      <form id="add-activity-form" class="space-y-4">
        <div>
          <label for="activity-input" class="block text-sm font-medium text-gray-700 mb-1">Actividad</label>
          <input type="text" id="activity-input" required placeholder="Nombre de la actividad" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label for="day-input" class="block text-sm font-medium text-gray-700 mb-1">D√≠a</label>
            <select id="day-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
              <option value="">Seleccionar d√≠a</option>
              <option value="Lunes">Lunes</option>
              <option value="Martes">Martes</option>
              <option value="Mi√©rcoles">Mi√©rcoles</option>
              <option value="Jueves">Jueves</option>
              <option value="Viernes">Viernes</option>
              <option value="S√°bado">S√°bado</option>
              <option value="Domingo">Domingo</option>
            </select>
          </div>
          <div>
            <label for="time-input" class="block text-sm font-medium text-gray-700 mb-1">Hora</label>
            <input type="time" id="time-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          </div>
          <div>
            <label for="year-input" class="block text-sm font-medium text-gray-700 mb-1">A√±o</label>
            <input type="number" id="year-input" required min="2024" max="2030" value="2025" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          </div>
        </div>
        <button type="submit" id="add-button" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-300 shadow-lg">
          Agregar Nueva Actividad
        </button>
      </form>
    </div>
   </div>
  </div>

  <script>
    const defaultConfig = {
      page_title: "Horarios de Actividades",
      add_button_text: "Agregar Nueva Actividad",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      card_background: "#ffffff",
      text_color: "#1f2937",
      button_color: "#8b5cf6",
      font_family: "Segoe UI",
      font_size: 16
    };

    const PREDEFINED_ACTIVITIES = [
      { activity: "Cita M√©dica", day: "Lunes", time: "09:00", year: 2025 },
      { activity: "Yoga Matutino", day: "Lunes", time: "07:30", year: 2025 },
      { activity: "Compras del Mercado", day: "Martes", time: "10:00", year: 2025 },
      { activity: "Reuni√≥n Familiar", day: "Martes", time: "16:00", year: 2025 },
      { activity: "Caminata en el Parque", day: "Mi√©rcoles", time: "08:00", year: 2025 },
      { activity: "Club de Lectura", day: "Mi√©rcoles", time: "15:00", year: 2025 },
      { activity: "Fisioterapia", day: "Jueves", time: "11:00", year: 2025 },
      { activity: "Almuerzo con Amigos", day: "Jueves", time: "13:00", year: 2025 },
      { activity: "Jardiner√≠a", day: "Viernes", time: "09:00", year: 2025 },
      { activity: "Noche de Pel√≠culas", day: "Viernes", time: "20:00", year: 2025 }
    ];

    let allActivities = [];
    let countdownInterval;

    // Inicializaci√≥n principal
    async function initializeApp() {
      try {
        if (window.dataSdk && typeof window.dataSdk.init === "function") {
          const initResult = await window.dataSdk.init({
            onDataChanged(data) {
              allActivities = data;
              renderActivities();
            }
          });
          if (!initResult.isOk) console.warn("‚ö†Ô∏è No se pudo inicializar Data SDK:", initResult.error);
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è Ejecutando en modo local (sin SDK).");
      }

      renderActivities();
      startCountdownUpdates();
    }

    function getNextOccurrence(dayName, timeStr, year) {
      const days = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
      const targetDay = days.indexOf(dayName);
      const [hours, minutes] = timeStr.split(':').map(Number);
      const now = new Date();
      const result = new Date(year, now.getMonth(), now.getDate(), hours, minutes, 0, 0);
      while (result.getDay() !== targetDay) result.setDate(result.getDate() + 1);
      return result;
    }

    function getTimeUntil(day, time, year) {
      const next = getNextOccurrence(day, time, year);
      const diff = next - new Date();
      if (diff <= 0) return "Ya pas√≥";
      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const m = Math.floor((diff / (1000 * 60)) % 60);
      return d > 0 ? `${d}d ${h}h` : h > 0 ? `${h}h ${m}m` : `${m}m`;
    }

    function renderActivities() {
      const grid = document.getElementById('activities-grid');
      const displayActivities = [
        ...PREDEFINED_ACTIVITIES.map((a, i) => ({ id: "predef-" + i, ...a, isPredefined: true })),
        ...allActivities
      ];
      grid.innerHTML = displayActivities.map(a => `
        <div class="activity-card rounded-xl shadow-lg p-4 fade-in bg-white" data-activity-id="${a.id}">
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-lg font-bold">${a.activity}</h3>
            ${!a.isPredefined ? `<button onclick="deleteActivity('${a.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>` : ''}
          </div>
          <p>üìÖ ${a.day}</p>
          <p>üïê ${a.time}</p>
          <p>üìÜ ${a.year}</p>
          <p class="countdown text-indigo-500" data-day="${a.day}" data-time="${a.time}" data-year="${a.year}">
            ‚è±Ô∏è ${getTimeUntil(a.day, a.time, a.year)}
          </p>
        </div>
      `).join('');
    }

    function startCountdownUpdates() {
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        document.querySelectorAll('.countdown').forEach(c => {
          const { day, time, year } = c.dataset;
          c.innerHTML = `‚è±Ô∏è ${getTimeUntil(day, time, parseInt(year))}`;
        });
      }, 60000);
    }

    async function deleteActivity(id) {
      allActivities = allActivities.filter(a => a.id !== id);
      renderActivities();
      showMessage('Actividad eliminada', 'success');
    }

    function showMessage(text, type = 'success') {
      const bg = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      const div = document.createElement('div');
      div.className = `fixed top-4 right-4 ${bg} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
      div.textContent = text;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // ‚úÖ VERSI√ìN SIN SDK (funcional en local)
    document.getElementById('add-activity-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const activity = document.getElementById('activity-input').value.trim();
      const day = document.getElementById('day-input').value;
      const time = document.getElementById('time-input').value;
      const year = parseInt(document.getElementById('year-input').value);

      if (!activity || !day || !time || !year) {
        showMessage('Por favor completa todos los campos', 'error');
        return;
      }

      const submitBtn = document.getElementById('add-button');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Agregando...';

      const newActivity = {
        id: `activity-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        activity, day, time, year,
        createdAt: new Date().toISOString()
      };

      try {
        let success = false;
        if (window.dataSdk && typeof window.dataSdk.create === 'function') {
          const result = await window.dataSdk.create(newActivity);
          success = result?.isOk;
        } else {
          allActivities.push(newActivity);
          renderActivities();
          success = true;
        }

        submitBtn.disabled = false;
        submitBtn.textContent = originalText;

        if (success) {
          e.target.reset();
          document.getElementById('year-input').value = '2025';
          showMessage('¬°Actividad agregada exitosamente!', 'success');
        } else {
          showMessage('Error al agregar la actividad', 'error');
        }

      } catch (error) {
        console.error("Error al agregar:", error);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        showMessage('Error al agregar la actividad', 'error');
      }
    });

    // Inicializar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
 </body>
</html>
